# Arithmetic Encoder - Verification

## Introduction
- The verification process is comprised by several _.sv_ (SystemVerilog) files.
- Each file has a specific purpose and targets the verification of a specific block of the architecture.
- For blocks related directly to the AV1 codec functionality (i.e., stages 1--4), input datasets must be generated from the [AV1 Reference Codebase](https://aomedia.googlesource.com/aom) using the [entenc.c](AV1-reference-info/entenc.c) modified file.
- Blocks that aren't related to the AV1 codec (i.e., ([LZC.v](../rtl/entropy-encoder-original/LZC.v)) have their data randomly generated by the _SystemVerilog_ testbench.

## Files

The [verification_area](../verification_area) comprises several SystemVerilog files that allow different kinds of simulation.

- [testbenches/tb_1-bool.sv](testbenches/tb_1-bool.sv) testbench for [entropy-encoder-original](../rtl/entropy-encoder-original), [entropy-encoder-lp](../rtl/entropy-encoder-lp), [entropy-encoder-1-bool](../rtl/entropy-encoder-1-bool) and [entropy-encoder-1-bool-lp](../rtl/entropy-encoder-1-bool-lp);
- [testbenches/tb_2-bool.sv](testbenches/tb_2-bool.sv) testbench for [entropy-encoder-2-bool](../rtl/entropy-encoder-2-bool) and [entropy-encoder-2-bool-lp](../rtl/entropy-encoder-2-bool-lp);
- [testbenches/tb_3-bool.sv](testbenches/tb_3-bool.sv) testbench for [entropy-encoder-3-bool](../rtl/entropy-encoder-3-bool) and [entropy-encoder-3-bool-lp](../rtl/entropy-encoder-3-bool-lp);
- [testbenches/tb_4-bool.sv](testbenches/tb_4-bool.sv) testbench for [entropy-encoder-4-bool](../rtl/entropy-encoder-4-bool);
- [testbenches/tb_arith_encoder.sv](testbenches/tb_arith_encoder.sv) is a SystemVerilog that only simulates the sub-module 'Arith_Encoder' (this sub-module comprises the pipeline stages 1, 2 and 3);
- [testbenches/components/](/testbenches/components) is a directory that comprises testbenches for the different modules found within the repository ([LZC.v](../rtl/other-blocks/vedic-multiplier/vedic_16x16.v), etc);
- [testbenches/Stages](testbenches/Stages) is a directory that comprises testbenches for each of the architecture's blocks.

## Input Files

- All testbenches rely on input data. Sometimes, the input data is randomly generated by the SystemVerilog code itself. However, offenly an input data is required so the testbench and validate the architecture under real world scenarios.

- For all testbenches used to validate the architecture's modules ([tb_1-bool.sv](testbenches/tb_1-bool.sv), [tb_arith_encoder.sv](testbenches/tb_arith_encoder.sv) or the individual pipeline stages) the input data can be easily generate using the [AV1 Reference Codebase](https://aomedia.googlesource.com/aom) and the modified [entenc.c](AV1-reference-info/entenc.c). This execution will generate a <code>.csv</code> file that can be used to simulate the architecture using the testbenches. As one may notice, it'll indeed be necessary for the user to switch the filepaths inside the <code>.sv</code> files.

- For testbenches used to validate components that aren't directly related to the AV1 codec (i.e., LZC or Vedic multiplier), the .sv testbenches will randomly generate input values so it can cover a greater area of the architecture and more accurately validate it.

### How to generate the input file?
1. Download the modified file of the AV1's entropy encoder, [entenc.c](AV1-reference-info/entenc.c);
2. Download/clone the [AV1's reference code](https://aomedia.googlesource.com/aom/);
3. Copy and overwrite the file <code>entenc.c</code> modified into the folder <code>aom/aom_dsp</code>;
4. Run any encoding process according to the procedure as specified in the AV1's website;
5. After the encoding process is completed, access the folder <code>arith_analysis</code> created;
6. The normal data sequence for the testbench is a file called <code>main_data</code>.

## Observation

- The herein cited testbenches were simulated until **Altera ModelSim**. Therefore, the use of other softwares might required some changes upon the <code>.sv</code> files, or even on the <code>rtl</code> files.

## Modelsim Flow
- _Problem?_ Running simulation using the Altera Modelsim tool doesn't allow the use of different datasets. Hence, it was created the <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code> script to solve this problem.
### <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code> features
- Easy to configure:
  1. Set the <code>arc_version</code> variable to define the waveforms to be added into the proper Modelsim window;
  2. If the testbench is set to generate VCD files for each simulation, set <code>dump_vcd</code> to 1. Otherwise, leave it 0;
  3. Take the corresponding testbench from [testbenches](testbenches) and set the constant <code>MODELSIM_FLOW</code> to one. Change the <code>DUMPFILE</code> variable in the testbench according to step 2;
  4. Make sure <code>TARGET_PATH</code> in the testbench matches with <code>target_path</code> in <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code>;
  5. Use the variable <code>set_dataset</code> in <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code> or modify the _if_ statement around line 40 to reflect your sequence directory. The script will read the directories according to the following path: <code>cqs/configs/videos</code>.
  6. As a follow-up for **5.**, set the <code>final_bitstream</code> and <code>final_main</code> in <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code> to reflect the suffix used for the <code>bitstream</code> and <code>main_data</code> files for each video sequence.
    - The file with all inputs will be set to: <code>${videos}-${final_main}</code>
    - The file with all outputs for verification will be set to: <code>${videos}-${final_bitstream}</code>
  7. Make sure <code>TARGET_MAIN</code> and <code>TARGET_BITSTREAM</code> in the testbench match with <code>${target_name}-${final_main}</code> and <code>${target_name}-${final_bitstream}</code>, respectively, in the <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code>.
- Most of the above presented steps are just part of a check-list to ensure the correct execution of the flow.
- The <code>[modelsim_flow.tcl](Modelsim/modelsim_flow.tcl)</code> relies on the idea of moving the datasets to an specific directory to be read by the testbench.
- The execution loop is defined by:
  1. The flow moves each dataset (<code>main_data</code> and <code>bitstream</code>),
  2. Runs the simulation,
  3. Deletes the dataset, and
  4. Restarts with another video sequence.
